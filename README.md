[Русский](#русский) | [English](#english)

# <a name="русский"></a>Русская версия
---

## Умный выключатель для бойлера на базе ESPhome с автономным расписанием

Этот проект представляет собой прошивку для умного выключателя на базе модуля `CB3S` (чип `bk72xx`), предназначенную для управления бойлером или другим мощным нагревательным прибором.

Ключевой особенностью является **полностью автономное расписание работы**, которое настраивается через интерфейс Home Assistant, но исполняется на самом устройстве. Это гарантирует работу бойлера по графику даже при отсутствии связи с сервером Home Assistant или Wi-Fi.

### Основные возможности

*   **Автономная работа по расписанию**: Расписание хранится в энергонезависимой памяти устройства и продолжает работать без подключения к Wi-Fi/Home Assistant.
*   **Гибкая настройка расписания**: Расписание задается в виде простой текстовой строки через интерфейс Home Assistant, поддерживается несколько интервалов включения в течение дня.
*   **Ручное управление**: Возможность включить/выключить реле физической кнопкой на выключателе или через интерфейс Home Assistant в любой момент.
*   **Восстановление состояния**: Продуманная логика восстановления состояния после сбоя питания — устройство не включится без надобности, а применит логику расписания.
*   **Визуальная индикация**:
    *   **Синий/красный светодиод**: Показывает состояние реле (включено/выключено).
    *   **Нормально выключенный/мигающй синий светодиод**: Отображает статус подключения к Wi-Fi и API Home Assistant.
*   **Стандартные функции ESPhome**: Поддержка OTA (обновления "по воздуху"), встроенный веб-сервер для диагностики, логирование.

### Требования

#### Аппаратное обеспечение

*   Умный выключатель на базе чипа `BK72xx`, например, с модулем **CB3S**.
*   Подключенные к соответствующим пинам реле, физическая кнопка и два светодиода.

#### Программное обеспечение

*   Работающий экземпляр **Home Assistant**.
*   Установленное и настроенное дополнение **ESPhome** (с поддержкой платформы `LibreTiny` для чипов `bk72xx`).
*   Созданный в Home Assistant **текстовый помощник (`input_text.smartswitch_schedule`)** для хранения строки расписания.

### Установка и настройка

1.  **Секреты (`secrets.yaml`)**
    Убедитесь, что у вас есть файл `secrets.yaml` в корневой папке ESPhome, и он содержит необходимые ключи (пароли от Wi-Fi, ключи API и т.д.). `timezone` должен содержать значение часового пояса, в котором вы находитесь (https://timezonedb.com/time-zones)
#### Рекомендуемый файл секретов
```yaml
wifi_ssid: "SSID"
wifi_password: "WIFI_PASSWORD"
ota_password: "000111222456"
fallback_password: "000111222456"
api_encryption_key: "autogenerated_api_encryption_key"
timezone: "Asia/Jerusalem"
```
3.  **Помощник в Home Assistant**
    Создайте текстового помощника для управления расписанием с `entity_id` `input_text.smartswitch_schedule`. Если вы назвали его иначе, измените `entity_id` в файле `smartswitch01.yaml`.
    Расписание является собой строкой значений, разделенных точкой с запятой, где каждое значение является временем включения и выключения в 24-часовом формате, разделенные дефисом, например: `05:30-07:00;09:00-10:00;11:00-12:00;20:00-22:00`. Если необходимо задать расписание, специфичное для определенного дня недели, добавьте один или несколько дней недели через запятую после символа дроби, например `05:30-07:00/2,4,6`. Неделя начинается с Воскресенья:
    1 - Воскресенье;
    2 - Понедельник;
    3 - Вторник;
    4 - Среда;
    5 - Четверг;
    6 - Пятница;
    7 - Суббота.
5.  **Конфигурация ESPhome (`smartswitch01.yaml`)**
    *   Скопируйте предоставленный файл `smartswitch01.yaml` в вашу папку с конфигурациями ESPhome.
    *   **Проверьте пины**: В блоке `substitutions` убедитесь, что номера пинов (`pin_relay`, `pin_button` и т.д.) соответствуют вашему устройству.

6.  **Прошивка устройства**
    Прошейте устройство через ESPhome, выбрав удобный для вас метод (USB или OTA).

### Управление в Home Assistant

Для удобного управления бойлером рекомендуется создать карточку на панели Lovelace.

#### Рекомендуемая карточка

```yaml
type: vertical-stack
title: Управление бойлером
cards:
  - type: entities
    entities:
      # Замените entity_id на ваши, если они отличаются
      - entity: switch.smartswitch01_relay
        name: Ручное управление
        icon: mdi:water-boiler
      - entity: sensor.smartswitch01_wifi_signal
        name: Сигнал Wi-Fi
      - entity: sensor.smartswitch01_boiler_smartswitch_uptime
        name: Время в сети
  - type: conditional
    conditions:
      - entity: sensor.smartswitch01_uptime
        state_not: unavailable
    card:
      type: entities
      entities:
        - entity: input_text.smartswitch_schedule
          name: Автономное расписание
          icon: mdi:calendar-clock
```
---
# <a name="english"></a>English Version
---

## ESPhome Smart Boiler Switch with Autonomous Scheduling

This project provides a firmware for a smart switch based on the `CB3S` module (`bk72xx` chip), designed for controlling a water heater (boiler) or other high-power heating appliances.

The key feature is a **fully autonomous scheduling system** that is configured via the Home Assistant interface but executed directly on the device. This ensures the boiler operates on schedule even if the connection to the Home Assistant server or Wi-Fi is lost.

### Key Features

*   **Autonomous Schedule Operation**: The schedule is stored in the device's non-volatile memory and continues to function without a connection to Wi-Fi or Home Assistant.
*   **Flexible Schedule Configuration**: The schedule is set as a simple text string via the Home Assistant interface, supporting multiple on/off intervals throughout the day.
*   **Manual Control**: Ability to toggle the relay at any time using the physical button on the switch or through the Home Assistant interface.
*   **Smart State Restoration**: A well-thought-out power-on behavior ensures the device does not turn on unnecessarily after a power outage, instead applying the schedule logic.
*   **Visual Indicators**:
    *   **Blue/red LED**: Shows the relay's state (on/off).
    *   **Normally off/blinking blue LED**: Displays the connection status to Wi-Fi and the Home Assistant API.
*   **Standard ESPhome Features**: Supports OTA (Over-the-Air) updates, an integrated web server for diagnostics, and logging.

### Requirements

#### Hardware

*   A smart switch based on the `BK72xx` chip, for example, one with a **CB3S** module.
*   A relay, a physical button, and two LEDs connected to the appropriate pins.

#### Software

*   A running instance of **Home Assistant**.
*   The **ESPhome** add-on installed and configured (with `LibreTiny` platform support for `bk72xx` chips).
*   A **Text Input Helper (`input_text.smartswitch_schedule`)** created in Home Assistant to store the schedule string.

### Installation and Setup

1.  **Secrets (`secrets.yaml`)**
    Ensure you have a `secrets.yaml` file in your root ESPhome directory containing the necessary keys (Wi-Fi credentials, API keys, etc.). `timezone` is for value of your time zone (https://timezonedb.com/time-zones)
#### Secrets file for reference
```yaml
wifi_ssid: "SSID"
wifi_password: "WIFI_PASSWORD"
ota_password: "000111222456"
fallback_password: "000111222456"
api_encryption_key: "autogenerated_api_encryption_key"
timezone: "Asia/Jerusalem"
```
2.  **Home Assistant Helper**
    Create a text input helper to manage the schedule. Its `entity_id` should be `input_text.smartswitch_schedule`. If you use a different name, update the `entity_id` in the `smartswitch01.yaml` file accordingly.
    Autonomous (Home Assistant independent) schedule may be set up with a string of semicolon-sepatated values, where each value is on and off time in 24-hours format, separated with dash, eg.: `05:30-07:00;09:00-10:00;11:00-12:00;20:00-22:00`

4.  **ESPhome Configuration (`smartswitch01.yaml`)**
    *   Copy the provided `smartswitch01.yaml` file into your ESPhome configuration directory.
    *   **Verify Pins**: In the `substitutions` block, ensure the pin numbers (`pin_relay`, `pin_button`, etc.) match your device's hardware.

5.  **Flashing the Device**
    Flash the device using ESPhome, choosing your preferred method (USB or OTA).

### Home Assistant Control

For convenient control of the boiler, it's recommended to create a card on your Lovelace dashboard.

#### Recommended Card

```yaml
type: vertical-stack
title: Boiler Control
cards:
  - type: entities
    entities:
      # Replace entity_ids with yours if they differ
      - entity: switch.smartswitch01_relay
        name: Manual Control
        icon: mdi:water-boiler
      - entity: sensor.smartswitch01_wifi_signal
        name: Wi-Fi Signal
      - entity: sensor.smartswitch01_boiler_smartswitch_uptime
        name: Uptime
  - type: conditional
    conditions:
      - entity: sensor.smartswitch01_boiler_smartswitch_uptime
        state_not: unavailable
    card:
      type: entities
      entities:
        - entity: input_text.smartswitch_schedule
          name: Autonomous Schedule
          icon: mdi:calendar-clock
```
